<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Jeffrey Way]]></title>
  <link href="http://jeffreyway.github.io/atom.xml" rel="self"/>
  <link href="http://jeffreyway.github.io/"/>
  <updated>2013-08-10T19:55:20-04:00</updated>
  <id>http://jeffreyway.github.io/</id>
  <author>
    <name><![CDATA[Jeffrey Way]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Faster Testing With My Package]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/08/10/faster-testing-with-my-package/"/>
    <updated>2013-08-10T19:51:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/08/10/faster-testing-with-my-package</id>
    <content type="html"><![CDATA[<p>I <a href="https://packagist.org/packages/way/laravel-test-helpers">released a package</a> months ago, but never really promoted it much. In
this five minute video, if you&#8217;re interested, let me give you a
whirlwind tour of what you can do with it.</p>

<!--more-->


<p><video width='640' height='400' preload='none' controls poster='http://2013-website.s3.amazonaws.com/videos/screenshots/Laravel-Test-Helpers-Tour.png'><source src='http://2013-website.s3.amazonaws.com/videos/Laravel-Test-Helpers-Tour.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'></video></p>

<p><a href="http://2013-website.s3.amazonaws.com/videos/Laravel-Test-Helpers-Tour.mp4">Download Video</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Laravel.io Podcast #2]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/08/05/laravel-dot-io-podcast-number-2/"/>
    <updated>2013-08-05T19:50:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/08/05/laravel-dot-io-podcast-number-2</id>
    <content type="html"><![CDATA[<p>Earlier this week, I was a guest on the second episode of the <a href="http://laravel.io/topic/41/podcast-2-laracon-architecture-testing-and-more">Laravel.io podcast</a>. If you&#8217;re interested in listening to three guys ramble on about Laravel architecture, testing, and the upcoming conference in Amsterdam, have a listen after the jump.</p>

<!--more-->


<p><audio controls>
<source src="http://2013-website.s3.amazonaws.com/videos/laravel-episode-2.mp3">
<a href="http://2013-website.s3.amazonaws.com/videos/laravel-episode-2.mp3">Download Podcast</a>
</audio></p>

<p>Alternatively, you can subscribe to the podcast on iTunes.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New Laravel 4 Generator: Pivot]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/08/02/new-laravel-4-generator-pivot/"/>
    <updated>2013-08-02T11:41:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/08/02/new-laravel-4-generator-pivot</id>
    <content type="html"><![CDATA[<p>Creating joinable/pivot tables can sometimes be confusing. Should the table names be plural? In what order do we write the table names to make Laravel happy? What fields should be in the pivot table?</p>

<p>I decided to add a pivot table helper generator to my <a href="https://packagist.org/packages/way/generators">Laravel 4 Generators
package</a>. It&#8217;s a cinch to
use!</p>

<!--more-->


<p><video width='640' height='400' preload='none' controls poster='http://2013-website.s3.amazonaws.com/videos/screenshots/Laravel-4-Generators-Pivot.png'><source src='http://2013-website.s3.amazonaws.com/videos/Laravel-4-Generators-Pivot.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'></video></p>

<p><a href="http://2013-website.s3.amazonaws.com/videos/Laravel-4-Generators-Pivot.mp4">Download Video</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php artisan generate:pivot tableOne tableTwo
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s it. Behind the scenes, Laravel will figure out what the table
name should be, and will also set the necessary fields. For example, a
post can have many tags, and a tag can have many posts. So, we need a
joinable table to connect the two, when performing DB queries. Easy!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php artisan generate:pivot posts tags
</span></code></pre></td></tr></table></div></figure>


<p>It doesn&#8217;t matter which order you provide the table names (or whether you pluralize them or not). The command will correctly create a <code>post_tag</code> migration that has <code>post_id</code> and <code>tag_id</code> fields.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Schema</span><span class="o">::</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;post_tag&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Blueprint</span> <span class="nx">$table</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$table</span><span class="o">-&gt;</span><span class="nx">increments</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$table</span><span class="o">-&gt;</span><span class="nx">integer</span><span class="p">(</span><span class="s1">&#39;post_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">unsigned</span><span class="p">()</span><span class="o">-&gt;</span><span class="nx">index</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">$table</span><span class="o">-&gt;</span><span class="nx">integer</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">unsigned</span><span class="p">()</span><span class="o">-&gt;</span><span class="nx">index</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">$table</span><span class="o">-&gt;</span><span class="nx">foreign</span><span class="p">(</span><span class="s1">&#39;post_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">onDelete</span><span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$table</span><span class="o">-&gt;</span><span class="nx">foreign</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">onDelete</span><span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, simply migrate the database to create it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>php artisan migrate
</span></code></pre></td></tr></table></div></figure>


<p>Finished!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA["The MVC Mindset" Teaser]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/07/25/teaser-of-the-mvc-mindset/"/>
    <updated>2013-07-25T14:22:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/07/25/teaser-of-the-mvc-mindset</id>
    <content type="html"><![CDATA[<p>My next course for <a href="http://tutsplus.com">Tuts+ Premium</a> will be released on the final day of July (2013). We have lots of courses that cover beginner-level PHP, and plenty more that focus on object-oriented programming and architecture. But what we didn&#8217;t yet have was a course that transitions the developer from messy, muddy procedural code, over to a
more structured MVC-based architecture.</p>

<p>Here&#8217;s an excerpt from the course: lesson seven.</p>

<p><video width='640' height='400' preload='none' controls poster='http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/7-Dedicated-Controllers.png'><source src='http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/7-Dedicated-Controllers.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'></video></p>

<p><a href="http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/7-Dedicated-Controllers.mp4">Download Video</a></p>

<blockquote><p>Stay tuned to <a href="http://twitter.com/tutspremium">@tutspremium</a> on Twitter
for the official release announcement next week!</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AspectMock is Pretty Neat]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/07/24/aspectmock-is-pretty-neat/"/>
    <updated>2013-07-24T14:48:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/07/24/aspectmock-is-pretty-neat</id>
    <content type="html"><![CDATA[<p>I&#8217;ve been toying around with a new PHP mocking library, <a href="https://github.com/Codeception/AspectMock">AspectMock</a> (built upon Go! AOP) that takes a
different approach - one that doesn&#8217;t necessarily require you to resort
to dependency injection.</p>

<p>I&#8217;ve only spent a matter of hours with this tool, but it just might
change the way I structure my projects in the future. I guess we&#8217;ll see.
Have a watch below and decide for yourself!</p>

<p><video width='640' height='400' preload='none' controls poster='http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/AspectMock-Is-Pretty-Neat.png'><source src='http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/AspectMock-Is-Pretty-Neat.mp4' type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'></video></p>

<p><a href="http://tutsplus.s3.amazonaws.com/tutspremium/Quick-Tips/AspectMock-Is-Pretty-Neat.mp4">Download Video</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Laravel Controllers]]></title>
    <link href="http://jeffreyway.github.io/blog/2013/04/20/testing-laravel-controllers/"/>
    <updated>2013-04-20T18:05:00-04:00</updated>
    <id>http://jeffreyway.github.io/blog/2013/04/20/testing-laravel-controllers</id>
    <content type="html"><![CDATA[<p>Testing controllers isn&#8217;t the easiest thing in the world. Well, let me rephrase that: testing them is a cinch; what&#8217;s difficult, at least at first, is determining <em>what</em> to test.</p>

<p>Should a controller test verify text on the page? Should it touch the database? Should it ensure that variables exist in the view? If this is your first hay-ride, these things can be confusing! Let me help.</p>

<blockquote><p>Controller tests should verify responses, ensure that the correct database access methods are triggered, and assert that the appropriate instance variables are sent to the view.</p></blockquote>

<!--more-->


<p>The process of testing a controller can be divided into three pieces.</p>

<ul>
<li><strong>Isolate:</strong> Mock all dependencies (perhaps excluding the <code>View</code>).</li>
<li><strong>Call:</strong> Trigger the desired controller method.</li>
<li><strong>Ensure:</strong> Perform assertions, verifying that the stage has been set properly.</li>
</ul>


<h2>The Hello World of Controller Testing</h2>

<p>The best way to learn these things is through examples. Here&#8217;s the &#8221;<em>hello world</em>&#8221; of controller testing in Laravel.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">PostsControllerTest</span> <span class="kr">extends</span> <span class="nx">TestCase</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">client</span><span class="o">-&gt;</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Laravel leverages a handful of Symfony&#8217;s components to ease the process of testing routes and views, including HttpKernel, DomCrawler, and BrowserKit. This is why it&#8217;s paramount that your PHPUnit tests inherit from, not <code>PHPUnit_Framework_TestCase</code>, but <code>TestCase</code>. Don&#8217;t worry, Laravel still extends the former, but it helps setup the Laravel app for testing, as well as provides a variety of helper assertion methods that you are encouraged to use. More on that shortly.</p>

<p>In the code snippet above, we make a <code>GET</code> request to <code>/posts</code>, or <code>localhost:8000/posts</code>. Assuming that this line is added to a fresh installation of Laravel, Symfony will throw a <code>NotFoundHttpException</code>. If working along, try it out by running <code>phpunit</code> from the command line.</p>

<pre><code>$ phpunit
1) PostsControllerTest::testIndex
Symfony\Component\HttpKernel\Exception\NotFoundHttpException:
</code></pre>

<p>In <em>human-speak</em>, this essentially translates to, &#8221;<em>Hey, I tried to call that route, but you don&#8217;t have anything registered, fool!</em>&#8221;</p>

<p>As you can imagine, this type of request is common enough to the point that it makes sense to provide a helper method, such as <code>$this-&gt;call()</code>. In fact, Laravel does that very thing! This means that the previous example can be refactored, like so:</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Overloading is Your Friend</h3>

<p>Though we&#8217;ll stick with the base functionality in this chapter, in my personal projects, I take things a step further by allowing for such methods as <code>$this-&gt;get()</code>, <code>$this-&gt;post()</code>, etc. Thanks to PHP overloading, this only requires the addition of a single method, which you could add to <code>app/tests/TestCase.php</code>.</p>

<figure class='code'><figcaption><span>app/tests/TestCase.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">__call</span><span class="p">(</span><span class="nx">$method</span><span class="p">,</span> <span class="nx">$args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">in_array</span><span class="p">(</span><span class="nx">$method</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">]))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="nx">$method</span><span class="p">,</span> <span class="nx">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nx">BadMethodCallException</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, you&#8217;re free to write <code>$this-&gt;get('posts')</code> and achieve the exact same result as the previous two examples. As noted above, however, let&#8217;s stick with the framework&#8217;s base functionality for simplicity&#8217;s sake.</p>

<p>To make the test pass, we only need to prepare the proper route.</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s1">&#39;all posts&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running <code>phpunit</code> again will return us to green.</p>

<h2>Laravel&#8217;s Helper Assertions</h2>

<p>A test that you&#8217;ll find yourself writing repeatedly is one that ensures that a controller passes a particular variable to a view. For example, the <code>index</code> method of <code>PostsController</code> should pass a <code>$posts</code> variable to its associated view, right? That way, the view can filter through all posts, and display them on the page. This is an important test to write!</p>

<p>If it&#8217;s that common a task, then, once again, wouldn&#8217;t it make sense for Laravel to provide a helper assertion to accomplish this very thing? Of course it would. And, of course, Laravel does!</p>

<p><code>Illuminate\Foundation\Testing\TestCase</code> includes a number of methods that will drastically reduce the amount of code needed to perform basic assertions. This list includes:</p>

<ul>
<li><code>assertViewHas</code></li>
<li><code>assertResponseOk</code></li>
<li><code>assertRedirectedTo</code></li>
<li><code>assertRedirectedToRoute</code></li>
<li><code>assertRedirectedToAction</code></li>
<li><code>assertSessionHas</code></li>
<li><code>assertSessionHasErrors</code></li>
</ul>


<p>The following examples calls <code>GET /posts</code> and verifies that its views receives the variable, <code>$posts</code>.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Tip:</strong> When it comes to formatting, I prefer to provide a line break between a test&#8217;s assertion and the code that prepares the stage.</p></blockquote>

<p><code>assertViewHas</code> is simply a bit of sugar that inspects the response object - which is returned from <code>$this-&gt;call()</code> - and verifies that the data associated with the view contains a <code>posts</code> variable.</p>

<p>When inspecting the response object, you have two core choices.</p>

<ul>
<li><code>$response-&gt;getOriginalContent()</code>: Fetch the original content, or the returned <code>View</code>. Optionally, you may access the <code>original</code> property directly, rather than calling the <code>getOriginalContent</code> method.</li>
<li><code>$response-&gt;getContent()</code>: Fetch the rendered output. If a <code>View</code> instance is returned from the route, then <code>getContent()</code> will be equal to the HTML output. This can be helpful for DOM verifications, such as &#8221;<em>the view must contain this string.</em>&#8221;</li>
</ul>


<p>Let&#8217;s assume that the <code>posts</code> route consists of:</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Should we run <code>phpunit</code>, it will squawk with a helpful <em>next step</em> message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>1<span class="o">)</span> PostsControllerTest::testIndex
</span><span class='line'>Failed asserting that an array has the key <span class="s1">&#39;posts&#39;</span>.
</span></code></pre></td></tr></table></div></figure>


<p>To make it green, we simply fetch the posts and pass it to the view.</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">$posts</span><span class="p">]);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>One thing to keep in mind is that, as the code currently stands, it only ensures that the variable, <code>$posts</code>, is passed to the view. It doesn&#8217;t inspect its value. The <code>assertViewHas</code> optionally accepts a second argument to verify the value of the variable, as well as its existence.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this modified code, unles the view has a variable, <code>$posts</code>, that is equal to <code>foo</code>, the test will fail. In this situation, though, it&#8217;s likely that we&#8217;d rather not specify a value, but instead declare that the value be an instance of Laravel&#8217;s <code>Illuminate\Database\Eloquent\Collection</code> class. How might we accomplish that? PHPUnit provides a helpful <code>assertInstanceOf</code> assertion to fill this very need!</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$response</span> <span class="o">=</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// getData() returns all vars attached to the response.</span>
</span><span class='line'>    <span class="nx">$posts</span> <span class="o">=</span> <span class="nx">$response</span><span class="o">-&gt;</span><span class="nx">original</span><span class="o">-&gt;</span><span class="nx">getData</span><span class="p">()[</span><span class="s1">&#39;posts&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertInstanceOf</span><span class="p">(</span><span class="s1">&#39;Illuminate\Database\Eloquent\Collection&#39;</span><span class="p">,</span> <span class="nx">$posts</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this modification, we&#8217;ve declared that the controller <strong>must</strong> pass <code>$posts</code> - an instance of <code>Illuminate\Database\Eloquent\Collection</code> - to the view. Excellent.</p>

<h2>Mocking the Database</h2>

<p>There&#8217;s one glaring problem with our tests so far. Did you catch it?</p>

<blockquote><p>For each test, a SQL query is being executed on the database. Though this is useful for certain kinds of testing (acceptance, integration), for basic controller testing, it will only serve to decrease performance.</p></blockquote>

<p>I&#8217;ve drilled this into your skull multiple times at this point. We&#8217;re not interested in testing Eloquent&#8217;s ability to fetch records from a database. It has its own tests. Taylor knows it works! Let&#8217;s not waste time and processing power repeating those same tests.</p>

<p>Instead, it&#8217;s best to mock the database, and merely verify that the appropriate methods are called with the correct arguments. Or, in other words, we want to ensure that <code>Post::all()</code> never fires and hits the database. We know that works, so it doesn&#8217;t require testing.</p>

<p>This section will depend heavily on the Mockery library. Please review that chapter <a href="http://leanpub.com/laravel-testing-decoded">from my book</a>, if you&#8217;re not yet familiar with it.</p>

<h3>RequiredÂ Refactoring</h3>

<p>Unfortunately, so far, we&#8217;ve structured the code in a way that makes it virtually impossible to test.</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Ouch. We can&#39;t test this!!</span>
</span><span class='line'>    <span class="nx">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="o">-&gt;</span><span class="kd">with</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">$posts</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is precisely why it&#8217;s considered bad practice to nest Eloquent calls into your controllers. Don&#8217;t confuse Laravel&#8217;s facades, which are testable and can be swapped out with mocks (<code>Queue::shouldReceive()</code>), with your Eloquent models. The solution is to inject the database layer into the controller through the constructor. This requires some refactoring.</p>

<blockquote><p><strong>Warning:</strong> Storing logic within route callbacks is useful for small projects and APIs, but they make testing incredibly difficult. For applications of any considerable size, use controllers.</p></blockquote>

<p>Let&#8217;s register a new resource by replacing   the <code>posts</code> route with:</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Route</span><span class="o">::</span><span class="nx">resource</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="s1">&#39;PostsController&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230;and create the necessary resourceful controller with Artisan.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>php artisan controller:make PostsController
</span><span class='line'>Controller created successfully!
</span></code></pre></td></tr></table></div></figure>


<p>Now, rather than referencing the <code>Post</code> model directly, we&#8217;ll inject it into the controller&#8217;s constructor. Here&#8217;s a condensed example that omits all restful methods except the one that we&#8217;re currently interested in testing.</p>

<figure class='code'><figcaption><span>app/controllers/PostsController.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">PostsController</span> <span class="kr">extends</span> <span class="nx">BaseController</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">protected</span> <span class="nx">$post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">public</span> <span class="kd">function</span> <span class="nx">__construct</span><span class="p">(</span><span class="nx">Post</span> <span class="nx">$post</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">post</span> <span class="o">=</span> <span class="nx">$post</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">public</span> <span class="kd">function</span> <span class="nx">index</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nx">$posts</span> <span class="o">=</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">post</span><span class="o">-&gt;</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="o">-&gt;</span><span class="kd">with</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="nx">$posts</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that it&#8217;s a better idea to typehint an interface, rather than reference the Eloquent model, itself. But, one thing at a time! Let&#8217;s work up to that.</p></blockquote>

<p>This is a significantly better way to structure the code. Because the model is now injected, we have the ability to swap it out with a mocked version for testing. Here&#8217;s an example of doing just that:</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">PostsControllerTest</span> <span class="kr">extends</span> <span class="nx">TestCase</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">__construct</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// We have no interest in testing Eloquent</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span> <span class="o">=</span> <span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">(</span><span class="s1">&#39;Eloquent&#39;</span><span class="p">,</span> <span class="s1">&#39;Post&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">tearDown</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">Mockery</span><span class="o">::</span><span class="nx">close</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span>
</span><span class='line'>             <span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span><span class='line'>             <span class="o">-&gt;</span><span class="nx">once</span><span class="p">()</span>
</span><span class='line'>             <span class="o">-&gt;</span><span class="nx">andReturn</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The key benfit to this restructuring is that, now, the database will never needlessly be hit. Instead, using Mockery, we merely verify that the <code>all</code> method is triggered on the model.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span>
</span><span class='line'>     <span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
</span><span class='line'>     <span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, if you choose to forego coding to an interface, and instead inject the <code>Post</code> model into the controller, a bit of trickery has to be used in order to get around Eloquent&#8217;s use of statics, which can clash with Mockery. This is why we hijack both the <code>Post</code> and <code>Eloquent</code> classes within the test&#8217;s constructor, before the official versions have been loaded. This way, we have a clean slate to declare any expectations. The downside, of course, is that we can&#8217;t default to any existing methods, through the use of Mockery methods, like <code>makePartial()</code>.</p>

<h3>The IoC Container</h3>

<p>Laravel&#8217;s IoC container drastically eases the process of injecting dependencies into your classes. Each time a controller is requested, it is resolved out of the IoC container. As such, when we need to declare that a mock version of <code>Post</code> should be used for testing, we only need to provide Laravel with the instance of <code>Post</code> that should be used.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Think of this code as saying, &#8221;<em>Hey Laravel, when you need an instance of <code>Post</code>, I want you to use my mocked version.</em>&#8221; Because the app extends the <code>Container</code> we have access to all IoC methods directly off of it.</p></blockquote>

<p>Upon instantiation of the controller, Laravel leverages the power of PHP reflection to read the typehint and inject the dependency for you. That&#8217;s right; you don&#8217;t have to write a single binding to allow for this; it&#8217;s automated!</p>

<h2>Redirections</h2>

<p>Another common expectation that you&#8217;ll find yourself writing is one that ensures that the user is redirected to the proper location, perhaps upon adding a new post to the database. How might we accomplish this?</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStore</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Assuming that we&#8217;re following a restful flavor, to add a new post, we&#8217;d <code>POST</code> to the collection, or <code>posts</code> (don&#8217;t confuse the <code>POST</code> request method with the resource name, which just happens to have the same name).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we only need to leverage another of Laravel&#8217;s helper assertions, <code>assertRedirectedToRoute</code>.</p>

<blockquote><p><strong>Tip:</strong> When a resource is registered with Laravel (<code>Route::resource()</code>), the framework will automatically register the necessary named routes. Run <code>php artisan routes</code> if you ever forget what these names are.</p></blockquote>

<p>You might prefer to also ensure that the <code>$_POST</code> superglobal is passed to the <code>create</code> method. Even though we aren&#8217;t physically submitting a form, we can still allow for this, via the <code>Input::replace()</code> method, which allows us to &#8220;stub&#8221; this array. Here&#8217;s the modified test, which uses Mockery&#8217;s <code>with()</code> method to verify the arguments passed to the method referenced by <code>shouldReceive</code>.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStore</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">Input</span><span class="o">::</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$input</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;My Title&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">once</span><span class="p">()</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="kd">with</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Paths</h2>

<p>One thing that we haven&#8217;t considered in this test is validation. There should be two separate paths through the <code>store</code> method, dependent upon whether the validation passes:</p>

<ol>
<li>Redirect back to the &#8220;Create Post&#8221; form, and display the form validation errors.</li>
<li>Redirect to the collection, or the named route, <code>posts.index</code>.</li>
</ol>


<blockquote><p>As a best practice, each test should represent but one path through your code.</p></blockquote>

<p>This first path will be for failed validation.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStoreFails</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Set stage for a failed validation</span>
</span><span class='line'>    <span class="nx">Input</span><span class="o">::</span><span class="nx">replace</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Failed validation should reload the create form</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.create&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The errors should be sent to the view</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertSessionHasErrors</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code snippet above explicitly declares which errors should exist. Alternatively, you may omit the argument to <code>assertSessionHasErrors</code>, in which case it will merely verify that a message bag has been flashed (in translation, your Redirection includes <code>withErrors($errors)</code>).</p>

<p>Now for the test that handles successful validation.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStoreSuccess</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Set stage for successful validation</span>
</span><span class='line'>    <span class="nx">Input</span><span class="o">::</span><span class="nx">replace</span><span class="p">([</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Foo Title&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
</span><span class='line'>         <span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Post&#39;</span><span class="p">,</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Should redirect to collection, with a success flash message</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;flash&#39;</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The production code for these two tests might look like:</p>

<figure class='code'><figcaption><span>app/controllers/PostsController.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">store</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$input</span> <span class="o">=</span> <span class="nx">Input</span><span class="o">::</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// We&#39;ll run validation in the controller for convenience</span>
</span><span class='line'>    <span class="c1">// You should export this to the model, or a service</span>
</span><span class='line'>    <span class="nx">$v</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="nx">$input</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;required&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">$v</span><span class="o">-&gt;</span><span class="nx">fails</span><span class="p">())</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Redirect</span><span class="o">::</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;posts.create&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="nx">withInput</span><span class="p">()</span>
</span><span class='line'>            <span class="o">-&gt;</span><span class="nx">withErrors</span><span class="p">(</span><span class="nx">$v</span><span class="o">-&gt;</span><span class="nx">messages</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">post</span><span class="o">-&gt;</span><span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Redirect</span><span class="o">::</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="o">-&gt;</span><span class="kd">with</span><span class="p">(</span><span class="s1">&#39;flash&#39;</span><span class="p">,</span> <span class="s1">&#39;Your post has been created!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the <code>Validator</code> is nested directly in the controller? Generally, I&#8217;d recommend that you abstract this away to a service. That way, you can test your validation in isolation from any controllers or  routes. Nonetheless, let&#8217;s leave things as they are for simplicity&#8217;s sake. One thing to keep in mind is that we aren&#8217;t mocking the <code>Validator</code>, though you certainly could do so. Because this class is a facade, it can easily be swapped out with a mocked version, via the Facade&#8217;s <code>shouldReceive</code> method, without us needing to worry about injecting an instance through the constructor. Win!</p>

<figure class='code'><figcaption><span>app/controllers/PostsController.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Validator</span><span class="o">::</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;make&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="nx">once</span><span class="p">()</span>
</span><span class='line'>    <span class="o">-&gt;</span><span class="nx">andReturn</span><span class="p">(</span><span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">([</span><span class="s1">&#39;fails&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;true&#39;</span><span class="p">]));</span>
</span></code></pre></td></tr></table></div></figure>


<p>From time to time, you&#8217;ll find that a method that needs to be mocked should return an object, itself. Luckily, with Mockery, this is a piece of cake: we only need to create an anonymous mock, and pass an array, which signals the method name and response value, respectively. As such:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">([</span><span class="s1">&#39;fails&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;true&#39;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>will prepare an object, containing a <code>fails()</code> method that returns <code>true</code>.</p>

<h2>Repositories</h2>

<p>To allow for optimal flexibility, rather than creating a direct link between your controller and an ORM, like Eloquent, it&#8217;s better to code to an interface. The considerable advantage to this approach is that, should you perhaps need to swap out Eloquent for, say, Mongo or Redis, doing so literally requires the modification of a single line. Even better, the controller doesn&#8217;t ever need to be touched.</p>

<blockquote><p>Repositories represent the data access layer of your application.</p></blockquote>

<p>What might an interface for managing the database layer of a <code>Post</code> look like? This should get you started.</p>

<figure class='code'><figcaption><span>app/repositories/PostRepositoryInterface.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Repositories</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">interface</span> <span class="nx">PostRepositoryInterface</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can certainly be extended, but we&#8217;ve added the bare minimum methods for the demo: <code>all</code>, <code>find</code>, and <code>create</code>. Notice that the repository interfaces are being stored within <code>app/repositories</code>. Because this folder is not autoloaded by default, we need to update the <code>composer.json</code> file for the application to reference it.</p>

<figure class='code'><figcaption><span>composer.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;autoload&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;classmap&quot;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="c1">// ....</span>
</span><span class='line'>    <span class="s2">&quot;app/repositories&quot;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>When a new class is added to this directory, don&#8217;t forget to <code>composer dump-autoload -o</code>. The <code>-o</code>, (<em>optimize</em>) flag is optional, but should always be used, as a best practice.</p></blockquote>

<p>If you attempt to inject this interface into your controller, Laravel will snap at you. Go ahead; try it out and see. Here&#8217;s the modified <code>PostController</code>, which has been updated to inject an interface, rather than the <code>Post</code> Eloquent model.</p>

<figure class='code'><figcaption><span>app/controllers/PostsController.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">use</span> <span class="nx">Repositories</span><span class="err">\</span><span class="nx">PostRepositoryInterface</span> <span class="nx">as</span> <span class="nx">Post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">PostsController</span> <span class="kr">extends</span> <span class="nx">BaseController</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">protected</span> <span class="nx">$post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">__construct</span><span class="p">(</span><span class="nx">Post</span> <span class="nx">$post</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">post</span> <span class="o">=</span> <span class="nx">$post</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">index</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$posts</span> <span class="o">=</span> <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">post</span><span class="o">-&gt;</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">View</span><span class="o">::</span><span class="nx">make</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;posts&#39;</span> <span class="o">=&gt;</span> <span class="nx">$posts</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you run the server and view the output, you&#8217;ll be met with the dreaded (but beautiful) Whoops error page, declaring that &#8221;<em>PostRepositoryInterface is not instantiable.</em>&#8221;</p>

<p><img src="http://jeffreyway.github.io/images/testing-controllers/instantiable.png"></p>

<p>If you think about it, of course the framework is squawking! Laravel is smart, but it&#8217;s not a mind reader. It needs to be told which implementation of the interface should be used within the controller.</p>

<p>For now, let&#8217;s add this binding to <code>app/routes.php</code>. Later, we&#8217;ll instead make use of service providers to store this sort of logic.</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">App</span><span class="o">::</span><span class="nx">bind</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Repositories\PostRepositoryInterface&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;Repositories\EloquentPostRepository&#39;</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verbalize this function call as, &#8221;<em>Laravel, baby, when you need an instance of <code>PostRepositoryInterface</code>, I want you to use <code>EloquentPostRepository</code>.</em>&#8221;</p>

<p><code>app/repositories/EloquentPostRepository</code> will simply be a wrapper around Eloquent that implements <code>PostRepositoryInterface</code>. This way, we&#8217;re not restricting the API (and every other implementation) to Eloquent&#8217;s interpretation; we can name the methods however we wish.</p>

<figure class='code'><figcaption><span>app/repositories/EloquentPostRepository.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Repositories</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">use</span> <span class="nx">Repositories</span><span class="err">\</span><span class="nx">PostRepositoryInterface</span><span class="p">;</span>
</span><span class='line'><span class="nx">use</span> <span class="nx">Post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">EloquentPostRepository</span> <span class="kr">implements</span> <span class="nx">PostRepositoryInterface</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Some might argue that the <code>Post</code> model should be injected into this implementation for testability purposes. If you agree, simply inject it through the constructor, per usual.</p></blockquote>

<p>That&#8217;s all it should take! Refresh the browser, and things should be back to normal. Only, now, your application is far better structured, and the controller is no longer linked to Eloquent.</p>

<p>Let&#8217;s imagine that, a few months from now, your boss informs you that you need to swap Eloquent out with Redis. Well, because you&#8217;ve structured your application in this future-proof way, you only need to create the new <code>app/repositories/RedisPostRepository</code> implementation:</p>

<figure class='code'><figcaption><span>app/repositories/RedisPostRepository.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Repositories</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">use</span> <span class="nx">Repositories</span><span class="err">\</span><span class="nx">PostRepositoryInterface</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">RedisPostRepository</span> <span class="kr">implements</span> <span class="nx">PostRepositoryInterface</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// return all with Redis</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// return find one with Redis</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// return create with Redis</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And update the binding:</p>

<figure class='code'><figcaption><span>app/routes.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">App</span><span class="o">::</span><span class="nx">bind</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Repositories\PostRepositoryInterface&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;Repositories\RedisPostRepository&#39;</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instantly, you&#8217;re now leveraging Redis in your controller. Notice how <code>app/controllers/PostsController.php</code> was never touched? That&#8217;s the beauty of it!</p>

<h2>Structure</h2>

<p>So far in this lesson, our organization has been a bit lacking. IoC bindings in the <code>routes.php</code> file? All repositories grouped together in one directory? Sure, that may work in the beginning, but, very quickly, it&#8217;ll become apparent that this doesn&#8217;t scale.</p>

<p>In the final section of this article, we&#8217;ll PSR-ify our code, and leverage service providers to register any applicable bindings.</p>

<blockquote><p>PSR-0 defines the mandatory requirements that must be adhered to for autoloader interoperability.</p></blockquote>

<p>A PSR-0 loader may be registered with Composer, via the <code>psr-0</code> object.</p>

<figure class='code'><figcaption><span>composer.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;autoload&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;psr-0&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;Way&quot;</span><span class="o">:</span> <span class="s2">&quot;app/lib/&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The syntax can be confusing at first. It certainly was for me. An easy way to decipher <code>"Way": "app/lib/"</code> is to think to yourself, &#8221;<em>The base folder for the <code>Way</code> namespace is located in <code>app/lib</code>.</em>&#8221; Of course, replace my last name with the name of your project. The directory structure to match this would be:</p>

<ul>
<li>app/

<ul>
<li>lib/

<ul>
<li>Way/</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>Next, rather than grouping all repositories into a <code>repositories</code> directory, a more elegant approach might be to categorize them into multiple directories, like so:</p>

<ul>
<li>app/

<ul>
<li>lib/

<ul>
<li>Way/

<ul>
<li>Storage/

<ul>
<li>Post/

<ul>
<li>PostRepositoryInterface.php</li>
<li>EloquentPostRepository.php</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>It&#8217;s vital that we adhere to this naming and folder convention, if we want the autoloading to work as expected. The only remaining thing to do is update the namespaces for <code>PostRepositoryInterface</code> and <code>EloquentPostRepository</code>.</p>

<figure class='code'><figcaption><span>app/lib/Way/Storage/Post/PostRepositoryInterface.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Way</span><span class="err">\</span><span class="nx">Storage</span><span class="err">\</span><span class="nx">Post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">interface</span> <span class="nx">PostRepositoryInterface</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/lib/Way/Storage/Post/EloquentPostRepository.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Way</span><span class="err">\</span><span class="nx">Storage</span><span class="err">\</span><span class="nx">Post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">use</span> <span class="nx">Post</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">EloquentPostRepository</span> <span class="kr">implements</span> <span class="nx">PostRepositoryInterface</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">find</span><span class="p">(</span><span class="nx">$id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Post</span><span class="o">::</span><span class="nx">create</span><span class="p">(</span><span class="nx">$input</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There we go; that&#8217;s much cleaner. But what about those pesky bindings? The routes file may be a convenient place to experiment, but it makes little sense to store them there permanently. Instead, we&#8217;ll use service providers.</p>

<blockquote><p>Service providers are nothing more than bootstrap classes that can be used to do anything you wish: register a binding, hook into an event, import a routes file, etc.</p></blockquote>

<p>A service provider&#8217;s <code>register()</code> will be triggered automatically by Laravel.</p>

<figure class='code'><figcaption><span>app/lib/Way/Storage/StorageServiceProvider.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">namespace</span> <span class="nx">Way</span><span class="err">\</span><span class="nx">Storage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">use</span> <span class="nx">Illuminate</span><span class="err">\</span><span class="nx">Support</span><span class="err">\</span><span class="nx">ServiceProvider</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">StorageServiceProvider</span> <span class="kr">extends</span> <span class="nx">ServiceProvider</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Triggered automatically by Laravel</span>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">register</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">bind</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;Way\Storage\Post\PostRepositoryInterface&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;Way\Storage\Post\EloquentPostRepository&#39;</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To make this file known to Laravel, you only need to include it in <code>app/config/app.php</code>, within the <code>providers</code> array.</p>

<figure class='code'><figcaption><span>app/config/app.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="nx">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Illuminate\Foundation\Providers\ArtisanServiceProvider&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;Illuminate\Auth\AuthServiceProvider&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="s1">&#39;Way\Storage\StorageServiceProvider&#39;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Good; now we have a dedicated file for registering new bindings.</p>

<h3>Updating the Tests</h3>

<p>With our new structure in place, rather than mocking the Eloquent model, itself, we can instead mock <code>PostRepositoryInterface</code>. Here&#8217;s an example of one such test:</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$mock</span> <span class="o">=</span> <span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">(</span><span class="s1">&#39;Way\Storage\Post\PostRepositoryInterface&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$mock</span><span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="s1">&#39;Way\Storage\Post\PostRepositoryInterface&#39;</span><span class="p">,</span> <span class="nx">$mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, we can improve this. It stands to reason that every method within <code>PostsControllerTest</code> will require a mocked version of the repository. As such, it&#8217;s better to extract some of this prep work into its own method, like so:</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">setUp</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">parent</span><span class="o">::</span><span class="nx">setUp</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="p">(</span><span class="s1">&#39;Way\Storage\Post\PostRepositoryInterface&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">mock</span><span class="p">(</span><span class="nx">$class</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$mock</span> <span class="o">=</span> <span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">(</span><span class="nx">$class</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">app</span><span class="o">-&gt;</span><span class="nx">instance</span><span class="p">(</span><span class="nx">$class</span><span class="p">,</span> <span class="nx">$mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">$mock</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">mock</span><span class="o">-&gt;</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad, ay?</p>

<p>Now, if you want to be super-fly, and are willing to add a touch of test logic to your production code, you could even perform your mocking within the Eloquent model! This would allow for:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Post</span><span class="o">::</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Behind the scenes, this would mock <code>PostRepositoryInterface</code>, and update the IoC binding. You can&#8217;t get much more readable than that!</p>

<p>Allowing for this syntax only requires you to update the <code>Post</code> model, or, better, a <code>BaseModel</code> that all of the Eloquent models extend. Here&#8217;s an example of the former:</p>

<figure class='code'><figcaption><span>app/models/Post.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">Post</span> <span class="kr">extends</span> <span class="nx">Eloquent</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kr">static</span> <span class="kd">function</span> <span class="nx">shouldReceive</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">$class</span> <span class="o">=</span> <span class="nx">get_called_class</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">$repo</span> <span class="o">=</span> <span class="s2">&quot;Way\\Storage\\{$class}\\{$class}RepositoryInterface&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">$mock</span> <span class="o">=</span> <span class="nx">Mockery</span><span class="o">::</span><span class="nx">mock</span><span class="p">(</span><span class="nx">$repo</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">App</span><span class="o">::</span><span class="nx">instance</span><span class="p">(</span><span class="nx">$repo</span><span class="p">,</span> <span class="nx">$mock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">call_user_func_array</span><span class="p">([</span><span class="nx">$mock</span><span class="p">,</span> <span class="s1">&#39;shouldReceive&#39;</span><span class="p">],</span> <span class="nx">func_get_args</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you can manage the inner &#8221;<em>Should I be embedding test logic into production code</em>&#8221; battle, you&#8217;ll find that this allows for significantly more readable tests.</p>

<figure class='code'><figcaption><span>app/tests/controllers/PostsControllerTest.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="kr">class</span> <span class="nx">PostsControllerTest</span> <span class="kr">extends</span> <span class="nx">TestCase</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">tearDown</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">Mockery</span><span class="o">::</span><span class="nx">close</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">testIndex</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">Post</span><span class="o">::</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertViewHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStoreFails</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">Input</span><span class="o">::</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$input</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.create&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertSessionHasErrors</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">public</span> <span class="kd">function</span> <span class="nx">testStoreSuccess</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nx">Input</span><span class="o">::</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$input</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Foo Title&#39;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">Post</span><span class="o">::</span><span class="nx">shouldReceive</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">once</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;posts&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$this</span><span class="o">-&gt;</span><span class="nx">assertRedirectedToRoute</span><span class="p">(</span><span class="s1">&#39;posts.index&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;flash&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It feels good, doesn&#8217;t it? Hopefully, this article hasn&#8217;t been too overwhelming. The key is to learn how to organize your repositories in such a way to make them as easy as possible to mock and inject into your controllers. As a result of that effort, your tests will be lightning fast!</p>

<blockquote><p>This article is an excerpt from my book, <a href="https://leanpub.com/laravel-testing-decoded">Laravel Testing Decoded</a>. Give it a read if you&#8217;d like to dig more into these topics!</p></blockquote>
]]></content>
  </entry>
  
</feed>
